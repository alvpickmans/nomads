name: dotnet package
on: 
  push:
    branches:
      - 'main'
      - '_init'

env:
  buildConfig: Release
  srcProjects: './src/**/*.csproj' 
  testProjects: './tests/**/*.csproj' 
  currentVersion: 0.1.0
  alphaVersion: '${{ env.currentVersion}}-alpha.${{ github.run_id }}'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet-version: ['6.0.x']

    steps:
      - uses: actions/checkout@v4
      - name: Setup dotnet ${{matrix.dotnet-version}}
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{matrix.dotnet-version}}

      - name: dotnet restore
        run: |
          find . -type f -name *.csproj \
            -exec dotnet restore {} \;

      - name: dotnet build
        run: |
          find . -type f -name *.csproj \
            -exec dotnet restore {} \
            --no-restore \
            --configuration ${{ env.buildConfig }} \
            /p:Version=${{ env.alphaVersion }} \;

      - name: dotnet test
        run: find ${{ env.testProjects }} -type f \
          -exec dotnet test {} \
          --no-build \
          --configuration ${{ env.buildConfig }} \;

      - name: dotnet pack
        run: |
          find ${{ env.srcProjects }} -type f \
            -exec dotnet pack \
            --no-build \
            --configuration ${{ env.buildConfig }}
            --output staging/packages

      - name: upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: Nomads
          path: staging/**/*.nupkg

